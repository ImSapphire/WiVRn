From 5c4a6ca72a62ec183011eeb66bc77b503f2aaa7c Mon Sep 17 00:00:00 2001
From: Simon Zeni <simon.zeni@collabora.com>
Date: Thu, 4 Sep 2025 11:54:58 -0400
Subject: [PATCH 5/8] xrt: add xrt_device_init function

---
 src/xrt/auxiliary/util/u_device.c     |  2 ++
 src/xrt/drivers/steamvr_lh/device.cpp |  2 ++
 src/xrt/include/xrt/xrt_device.h      | 11 +++++++++++
 tests/tests_cxx_wrappers.cpp          |  1 +
 4 files changed, 16 insertions(+)

diff --git a/src/xrt/auxiliary/util/u_device.c b/src/xrt/auxiliary/util/u_device.c
index 4252b0e59..2b75ffae9 100644
--- a/src/xrt/auxiliary/util/u_device.c
+++ b/src/xrt/auxiliary/util/u_device.c
@@ -327,6 +327,8 @@ u_device_allocate(enum u_device_alloc_flags flags, size_t size, size_t input_cou
 		snprintf(xdev->tracking_origin->name, XRT_TRACKING_NAME_LEN, "%s", "No tracking");
 	}
 
+	xrt_device_init(xdev);
+
 	return xdev;
 }
 
diff --git a/src/xrt/drivers/steamvr_lh/device.cpp b/src/xrt/drivers/steamvr_lh/device.cpp
index ac1612740..daaefd7b3 100644
--- a/src/xrt/drivers/steamvr_lh/device.cpp
+++ b/src/xrt/drivers/steamvr_lh/device.cpp
@@ -295,6 +295,8 @@ Device::~Device()
 
 Device::Device(const DeviceBuilder &builder) : xrt_device({}), ctx(builder.ctx), driver(builder.driver)
 {
+	xrt_device_init(this);
+
 	m_relation_history_create(&relation_hist);
 	std::strncpy(this->serial, builder.serial, XRT_DEVICE_NAME_LEN - 1);
 	this->serial[XRT_DEVICE_NAME_LEN - 1] = 0;
diff --git a/src/xrt/include/xrt/xrt_device.h b/src/xrt/include/xrt/xrt_device.h
index 8dc272bec..f3a0175e5 100644
--- a/src/xrt/include/xrt/xrt_device.h
+++ b/src/xrt/include/xrt/xrt_device.h
@@ -752,6 +752,17 @@ struct xrt_device
 	// Add new functions above destroy.
 };
 
+/*!
+ * Initializes the common fields of a @ref xrt_device
+ *
+ * @public @memberof xrt_device
+ */
+static inline void
+xrt_device_init(struct xrt_device *xdev)
+{
+	xrt_signal_init(&xdev->events.destroy);
+}
+
 /*!
  * Helper function for @ref xrt_device::update_inputs.
  *
diff --git a/tests/tests_cxx_wrappers.cpp b/tests/tests_cxx_wrappers.cpp
index 7dd36b6af..408975795 100644
--- a/tests/tests_cxx_wrappers.cpp
+++ b/tests/tests_cxx_wrappers.cpp
@@ -21,6 +21,7 @@ struct silly_device
 	silly_device(bool &destroyed_) : destroyed(&destroyed_)
 	{
 		base.destroy = [](xrt_device *xdev) { delete reinterpret_cast<silly_device *>(xdev); };
+		xrt_device_init(&base);
 	}
 	~silly_device()
 	{
-- 
2.52.0

